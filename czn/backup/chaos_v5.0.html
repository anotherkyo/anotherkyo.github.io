<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>카오스 시뮬레이터 v5</title>
<style>
:root{--bg:#121216;--panel:#17171a;--text:#e8eef6;--muted:#b7c2cf;--accent:#7bdff6;--accent2:#a67cff;--danger:#ff6b6b;--glass:rgba(255,255,255,0.03)}
body{margin:0;background:linear-gradient(180deg,#0f1012 0%,var(--bg) 100%);font-family:Inter,system-ui,Roboto,'Noto Sans KR',sans-serif;color:var(--text)}
.wrap{max-width:1200px;margin:22px auto;padding:18px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));box-shadow:0 8px 30px rgba(0,0,0,0.6)}
.header{display:flex;justify-content:space-between;align-items:center;gap:12px}
h1{margin:0;color:var(--accent)}
.lead{color:var(--muted);margin:6px 0 14px}
.grid{display:grid;grid-template-columns:2fr 1fr;gap:16px}
.panel{background:var(--panel);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
.controls{display:flex;gap:8px;align-items:center}
label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
input,select{padding:6px 8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)}
.btn{background:linear-gradient(90deg,var(--accent),var(--accent2));border:none;color:#071018;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--accent)}
.small{font-size:12px;color:var(--muted)}
.flex{display:flex;gap:8px;align-items:center}
.card-list{display:flex;flex-direction:column;gap:8px;max-height:420px;overflow:auto;padding-right:6px}
.card-item{display:grid;grid-template-columns:140px 1fr 80px;gap:10px;align-items:center;background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.00));padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02)}
.card-left{display:flex;flex-direction:column;gap:6px}
.card-mid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.card-right{text-align:right}
.gauge{height:28px;background:rgba(255,255,255,0.03);border-radius:10px;overflow:hidden;position:relative;margin-top:8px}
.gauge-fill{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width 300ms ease}
.gauge-text{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);font-weight:800;color:#021018}
.logs{height:220px;overflow:auto;background:rgba(0,0,0,0.25);padding:8px;border-radius:8px;font-family:monospace;font-size:13px;color:#e6eef6}
.alert{display:none;padding:10px;border-radius:8px;text-align:center;font-weight:800;color:#071018;background:var(--danger);margin-top:8px}
.section-title{font-weight:700;color:var(--accent);margin-bottom:8px}
.unique-wrap{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
.unique-card{padding:8px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border:1px solid rgba(123,223,246,0.06);display:flex;justify-content:space-between;align-items:center}
.unique-left{display:flex;flex-direction:column}
.help{font-size:12px;color:var(--muted);margin-top:6px}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div>
      <h1>카오스 시뮬레이터 v5</h1>
      <div class="lead">고유카드 8장 포함 — 중립/몬스터/금기 카드의 세이브데이터(pt)를 시뮬레이션합니다.</div>
    </div>
    <div class="controls">
      <div>
        <label class="small">티어</label>
        <input id="tier" type="number" min="1" value="1" style="width:96px" />
      </div>
      <div>
        <label class="small">번뜩임 확률(%)</label>
        <input id="sparkChance" type="number" min="0" max="100" value="20" style="width:96px" />
      </div>
      <div>
        <label class="small">신번뜩임 확률(%)</label>
        <input id="newsparkChance" type="number" min="0" max="100" value="10" style="width:96px" />
      </div>
      <div class="flex">
        <button id="addCard" class="btn">카드 추가</button>
        <button id="addDefaults" class="btn ghost">기본카드 생성</button>
        <button id="resetAll" class="btn ghost">초기화</button>
      </div>
    </div>
  </div>

  <div class="grid" style="margin-top:12px">
    <div>
      <div class="panel">
        <div class="section-title">카드 목록</div>
        <div class="card-list" id="cardList"></div>
      </div>

      <div class="panel" style="margin-top:12px">
        <div class="section-title">고유 카드 (Unique Cards)</div>
        <div class="unique-wrap" id="uniqueWrap"></div>
        <div class="help">고유일반1~3: 번뜩임 불가, 고유레어1~5: 번뜩임/신번뜩임 가능. 제거 체크 시 +20pt 추가.</div>
      </div>

    </div>
    <div>
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="small">저장 상한</div>
            <div id="capDisplay" style="font-weight:800">30 pt</div>
          </div>
          <div>
            <div class="small">총 누적 pt</div>
            <div id="totalDisplay" style="font-weight:800">0 pt</div>
          </div>
        </div>

        <div class="gauge" aria-hidden="true">
          <div id="gaugeFill" class="gauge-fill"></div>
          <div id="gaugeText" class="gauge-text">0 / 30 pt</div>
        </div>

        <div id="alertFull" class="alert">기억 게이지가 꽉 찼습니다!</div>
      </div>

      <div class="panel" style="margin-top:12px">
        <div class="section-title">로그</div>
        <div id="logs" class="logs"></div>
      </div>
    </div>
  </div>
</div>

<template id="cardTemplate">
  <div class="card-item">
    <div class="card-left">
      <select class="card-type">
        <option value="neutral">중립 카드</option>
        <option value="monster">몬스터 카드</option>
        <option value="taboo">금기 카드</option>
      </select>
      <div class="small muted">중립 20 / 몬스터 80 / 금기 20</div>
    </div>
    <div class="card-mid">
      <div>
        <label class="small">상태</label>
        <select class="state"><option value="normal">일반</option><option value="spark">번뜩임</option><option value="newspark">신 번뜩임</option></select>
      </div>
      <div>
        <label class="small">제거 횟수</label>
        <input class="remove-count" type="number" min="0" value="0" />
      </div>
      <div>
        <label class="small">복제 횟수</label>
        <input class="dup-count" type="number" min="0" value="0" />
      </div>
      <div>
        <label class="small">변환 횟수</label>
        <input class="trans-count" type="number" min="0" value="0" />
      </div>
      <div>
        <label class="small">고유 여부</label>
        <input type="checkbox" class="is-unique" />
      </div>
      <div>
        <label class="small">시작 제거</label>
        <input type="checkbox" class="is-startremove" />
      </div>
    </div>
    <div class="card-right">
      <div class="small">기여</div>
      <div style="font-weight:800"><span class="contrib">0</span> pt</div>
      <div style="margin-top:8px"><button class="btn ghost remove-row">삭제</button></div>
    </div>
  </div>
</template>

<script>
// Constants
const BASE = { neutral:20, monster:80, taboo:20 };
const REMAP = {1:0,2:10,3:30,4:50}; // 5+ =>70

// DOM
const tierEl = document.getElementById('tier');
const sparkChanceEl = document.getElementById('sparkChance');
const newsparkChanceEl = document.getElementById('newsparkChance');
const addCardBtn = document.getElementById('addCard');
const addDefaultsBtn = document.getElementById('addDefaults');
const resetAllBtn = document.getElementById('resetAll');
const cardListEl = document.getElementById('cardList');
const cardTemplate = document.getElementById('cardTemplate');
const uniqueWrap = document.getElementById('uniqueWrap');
const capDisplay = document.getElementById('capDisplay');
const totalDisplay = document.getElementById('totalDisplay');
const gaugeFill = document.getElementById('gaugeFill');
const gaugeText = document.getElementById('gaugeText');
const alertFull = document.getElementById('alertFull');
const logsEl = document.getElementById('logs');

let logs = [];

function calcCap(t){ return 30 + (Math.max(1,t)-1)*10; }
function mapCountToPt(c){ c = parseInt(c)||0; if(c<=1) return 0; if(c>=5) return 70; return REMAP[c]||0; }
function randChance(p){ return Math.random()*100 < p; }
function addLog(txt){ logs.unshift(`[${new Date().toLocaleTimeString()}] ${txt}`); renderLogs(); }
function renderLogs(){ logsEl.innerHTML = logs.map(l=>`<div>${escapeHtml(l)}</div>`).join(''); }
function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// Create general card
function createCard(prefType){
  const node = document.importNode(cardTemplate.content, true);
  const el = node.querySelector('.card-item');
  if(prefType) el.querySelector('.card-type').value = prefType;

  // randomize state based on probabilities
  const stateSel = el.querySelector('.state');
  if(randChance(parseFloat(newsparkChanceEl.value))){ stateSel.value = 'newspark'; }
  else if(randChance(parseFloat(sparkChanceEl.value))){ stateSel.value = 'spark'; }

  // events
  el.querySelectorAll('input,select').forEach(i=> i.addEventListener('input', updateAll));
  el.querySelector('.remove-row').addEventListener('click', ()=>{ el.remove(); addLog('카드 삭제'); updateAll(); });

  cardListEl.prepend(el);
  addLog('카드 추가');
  updateAll();
}

addCardBtn.addEventListener('click', ()=> createCard());
addDefaultsBtn.addEventListener('click', ()=>{
  // sample defaults
  createCard('neutral'); createCard('neutral'); createCard('monster'); createCard('taboo');
  addLog('기본 카드 자동 생성');
});
resetAllBtn.addEventListener('click', ()=>{ if(confirm('모든 카드와 고유카드를 초기화합니까?')){ cardListEl.innerHTML=''; initUniqueCards(); logs=[]; addLog('초기화 실행'); updateAll(); }});

// Unique cards setup
let uniqueCards = []; // array of objects representing slots
function initUniqueCards(){
  uniqueWrap.innerHTML = '';
  uniqueCards = [];
  // 고유일반1~3 (no spark/newspark)
  for(let i=1;i<=3;i++){
    const id = `고유일반${i}`;
    const obj = { id, rarity:'normal', removed:false, dup:0, trans:0, state:'normal' };
    uniqueCards.push(obj);
  }
  // 고유레어1~5 (spark/newspark allowed)
  for(let i=1;i<=5;i++){
    const id = `고유레어${i}`;
    const obj = { id, rarity:'rare', removed:false, dup:0, trans:0, state:'normal' };
    uniqueCards.push(obj);
  }

  // render
  uniqueCards.forEach((uc, idx)=>{
    const div = document.createElement('div'); div.className='unique-card';
    const left = document.createElement('div'); left.className='unique-left';
    const name = document.createElement('div'); name.style.fontWeight='700'; name.textContent = uc.id + (uc.rarity==='rare' ? ' (레어)' : ' (일반)');
    const controls = document.createElement('div'); controls.className='flex'; controls.style.marginTop='6px';

    // state select
    const stateSel = document.createElement('select'); stateSel.className='small';
    const optNormal = document.createElement('option'); optNormal.value='normal'; optNormal.text='일반'; stateSel.appendChild(optNormal);
    if(uc.rarity === 'rare'){
      const optSpark = document.createElement('option'); optSpark.value='spark'; optSpark.text='번뜩임'; stateSel.appendChild(optSpark);
      const optNS = document.createElement('option'); optNS.value='newspark'; optNS.text='신 번뜩임'; stateSel.appendChild(optNS);
    }
    stateSel.value = 'normal';
    stateSel.addEventListener('change', ()=>{ uc.state = stateSel.value; updateAll(); });

    // removal checkbox
    const remLabel = document.createElement('label'); remLabel.className='small'; remLabel.style.marginLeft='8px';
    const remChk = document.createElement('input'); remChk.type='checkbox'; remChk.style.marginRight='6px';
    remChk.addEventListener('change', ()=>{ uc.removed = remChk.checked; updateAll(); addLog(`${uc.id} 제거 상태: ${uc.removed ? '제거' : '복구'}`); });
    remLabel.appendChild(remChk); remLabel.appendChild(document.createTextNode('제거'));

    // dup and trans small inputs
    const dupInput = document.createElement('input'); dupInput.type='number'; dupInput.min='0'; dupInput.value='0'; dupInput.style.width='60px'; dupInput.className='small'; dupInput.addEventListener('input', ()=>{ uc.dup = parseInt(dupInput.value)||0; updateAll(); });
    const transInput = document.createElement('input'); transInput.type='number'; transInput.min='0'; transInput.value='0'; transInput.style.width='60px'; transInput.className='small'; transInput.addEventListener('input', ()=>{ uc.trans = parseInt(transInput.value)||0; updateAll(); });

    controls.appendChild(stateSel); controls.appendChild(remLabel); controls.appendChild(dupInput); controls.appendChild(transInput);

    left.appendChild(name); left.appendChild(controls);

    const right = document.createElement('div'); right.style.textAlign='right';
    const contrib = document.createElement('div'); contrib.className='small'; contrib.textContent='기여: '; const contribVal = document.createElement('span'); contribVal.style.fontWeight='800'; contribVal.textContent='0'; contrib.appendChild(contribVal);
    right.appendChild(contrib);

    div.appendChild(left); div.appendChild(right);
    uniqueWrap.appendChild(div);

    // store reference
    uc._el = div; uc._contribEl = contribVal; uc._stateSel = stateSel; uc._dupInput = dupInput; uc._transInput = transInput; uc._remChk = remChk;
  });
}

// calc contribution for a generic card element
function calcCardElContribution(el){
  const type = el.querySelector('.card-type').value; // neutral, monster, taboo
  const state = el.querySelector('.state').value; // normal,spark,newspark
  const removeCount = parseInt(el.querySelector('.remove-count').value)||0;
  const dupCount = parseInt(el.querySelector('.dup-count').value)||0;
  const transCount = parseInt(el.querySelector('.trans-count').value)||0;
  const isUnique = el.querySelector('.is-unique').checked;
  const isStartRemove = el.querySelector('.is-startremove').checked;

  let details = [];
  let base = BASE[type]||0;
  details.push(`기본:${base}`);

  let total = 0;
  if(type === 'taboo'){
    total += base; details.push('금기: 항상 저장');
  } else {
    total += base;
    // spark logic: for non-unique: spark +10, newspark +20; for unique handled elsewhere
    let sparkAdd = 0;
    if(state === 'spark') sparkAdd = isUnique ? 0 : 10;
    if(state === 'newspark') sparkAdd = 20;
    if(sparkAdd) details.push(`번뜩임:+${sparkAdd}`);
    total += sparkAdd;

    // removal
    const remPt = mapCountToPt(removeCount);
    if(removeCount>0) details.push(`제거 ${removeCount}회 -> ${remPt}`);
    let remExtra = 0;
    if(removeCount>0 && (isStartRemove || state==='spark' || state==='newspark')){ remExtra = 20; details.push('제거추가:+20'); }
    total += remPt + remExtra;

    // duplication
    const dupPt = mapCountToPt(dupCount);
    if(dupCount>0) details.push(`복제 ${dupCount}회 -> ${dupPt}`);
    total += dupPt;
    if(dupCount>0 && (state==='spark' || state==='newspark')){
      const dupSpark = (state==='spark') ? (isUnique?0:10) : 20;
      total += dupSpark * dupCount; details.push(`복제 번뜩임:+${dupSpark}*${dupCount}`);
    }

    // transform
    const transPt = transCount*10;
    if(transCount>0) details.push(`변환 ${transCount}회 -> ${transPt}`);
    total += transPt;
    if(transCount>0 && (state==='spark' || state==='newspark')){
      const transSpark = (state==='spark') ? (isUnique?0:10) : 20;
      total += transSpark * transCount; details.push(`변환 번뜩임:+${transSpark}*${transCount}`);
    }
  }

  // write contrib
  el.querySelector('.contrib').textContent = total;
  return { total, type, details };
}

// calc for unique card object
function calcUniqueContribution(uc){
  let total = 0;
  // base 0
  // spark: unique normal cannot have spark; unique rare: spark 0, newspark +20
  let sparkAdd = 0;
  if(uc.rarity === 'rare'){
    if(uc.state === 'spark') sparkAdd = 0;
    if(uc.state === 'newspark') sparkAdd = 20;
  }
  total += sparkAdd;

  // removal: checkbox -> treated as 1 removal occurrence
  if(uc.removed){
    const remCount = 1; // checkbox means removed once
    total += mapCountToPt(remCount); // mapCountToPt(1) => 0
    total += 20; // unique removal extra
  }

  // duplication & transform: follow regular rules
  total += mapCountToPt(uc.dup);
  if(uc.dup>0 && (uc.state==='spark' || uc.state==='newspark')){
    const dupSpark = uc.state==='spark' ? 0 : 20; // unique spark=0, newspark=20
    total += dupSpark * uc.dup;
  }
  total += uc.trans * 10;
  if(uc.trans>0 && (uc.state==='spark' || uc.state==='newspark')){
    const transSpark = uc.state==='spark' ? 0 : 20;
    total += transSpark * uc.trans;
  }

  // update UI
  if(uc._contribEl) uc._contribEl.textContent = total;
  return total;
}

function updateAll(){
  const tier = parseInt(tierEl.value)||1;
  const cap = calcCap(tier);
  capDisplay.textContent = `${cap} pt`;

  // general cards
  let total = 0; let cardCount = 0; let tabooCount = 0;
  Array.from(cardListEl.querySelectorAll('.card-item')).forEach(el=>{
    const r = calcCardElContribution(el);
    total += r.total; cardCount++; if(r.type==='taboo') tabooCount++;
  });

  // uniques
  uniqueCards.forEach(uc=>{
    const u = calcUniqueContribution(uc);
    total += u;
  });

  totalDisplay.textContent = `${total} pt`;
  gaugeFill.style.width = `${Math.min(100, Math.round((total/cap)*100))}%`;
  gaugeText.textContent = `${total} / ${cap} pt`;
  alertFull.style.display = total >= cap ? 'block' : 'none';

  addLog(`계산: Tier ${tier} (Cap ${cap}) -> 총 ${total}pt, 카드 ${cardCount}개, 금기 ${tabooCount}개`);
}

// init
initUniqueCards();
createCard(); createCard(); // start with two cards
updateAll();

// expose updateAll on inputs
[ tierEl, sparkChanceEl, newsparkChanceEl ].forEach(el=>el.addEventListener('input', updateAll));

</script>
</body>
</html>
