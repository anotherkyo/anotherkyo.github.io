<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>카오스 제로 나이트메어 - 세이브데이터 시뮬레이터</title>
  <style>
    /* 다크 네온 테마 */
    :root{
      --bg:#0b0f12;
      --panel:#0f1418;
      --muted:#9aa6b2;
      --neon-pink:#ff3d81;
      --neon-blue:#35d0ff;
      --neon-purple:#b86bff;
      --glass: rgba(255,255,255,0.04);
      --danger: #ff2e2e;
      --success: #27e08a;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#050608 0%, #071018 100%);font-family:Inter,system-ui,Segoe UI,Roboto,'Noto Sans KR',sans-serif;color:#e6eef6}
    .wrap{max-width:1100px;margin:24px auto;padding:20px;box-shadow:0 10px 40px rgba(0,0,0,0.6);border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03)}
    h1{margin:0 0 8px;font-size:20px;color:var(--neon-pink);letter-spacing:0.5px}
    p.lead{margin:0 0 18px;color:var(--muted)}

    .grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
    .panel{background:var(--panel);padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    select,input[type=number],input[type=text]{width:100%;padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    .row{display:flex;gap:10px;align-items:center}
    .btn{border:0;padding:8px 12px;border-radius:8px;cursor:pointer;background:linear-gradient(90deg,var(--neon-blue),var(--neon-purple));color:#021018;font-weight:600}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--neon-blue)}

    /* 카드 리스트 */
    .card-list{max-height:520px;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:8px}
    .card-item{display:grid;grid-template-columns:120px 1fr 40px;gap:8px;align-items:center;padding:8px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.02)}
    .card-main{display:flex;gap:8px;align-items:center}
    .small{font-size:12px;color:var(--muted)}
    .num-input{width:64px}

    /* 게이지 */
    .gauge-wrap{padding:12px;border-radius:10px;background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));border:1px solid rgba(255,255,255,0.02)}
    .gauge{height:28px;background:rgba(255,255,255,0.03);border-radius:8px;overflow:hidden;position:relative}
    .gauge-fill{height:100%;width:0%;background:linear-gradient(90deg,var(--neon-pink),var(--neon-blue));box-shadow:0 0 18px rgba(59,0,95,0.28);transition:width 300ms ease}
    .gauge-text{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);font-weight:700}

    /* 로그 */
    .logs{height:220px;overflow:auto;background:rgba(0,0,0,0.25);padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);font-family:monospace;font-size:12px}

    /* 알림 */
    .alert{display:none;padding:10px;border-radius:8px;text-align:center;font-weight:700;color:#0b0f12;background:linear-gradient(90deg,var(--neon-pink),var(--danger));box-shadow:0 4px 30px rgba(255,0,80,0.12);}

    /* responsive */
    @media (max-width:980px){.grid{grid-template-columns:1fr;}.wrap{margin:10px}}

    /* small helpers */
    .muted{color:var(--muted)}
    .flex{display:flex;gap:8px;align-items:center}
    .right{text-align:right}

  </style>
</head>
<body>
  <div class="wrap">
    <h1>카오스 제로 나이트메어 — 세이브데이터 시뮬레이터</h1>
    <p class="lead">티어별 상한과 카드별 행동(제거/복제/변환/번뜩임)을 입력하면 흐릿한 기억(pt)를 실시간 계산해줍니다. 게이지가 꽉 차면 네온 경고가 표시됩니다.</p>

    <div class="grid">
      <div>
        <div class="panel" style="margin-bottom:12px">
          <div class="row" style="justify-content:space-between;align-items:center">
            <div style="flex:1">
              <label>티어 (Tier)</label>
              <input id="tier" type="number" min="1" value="1" />
            </div>
            <div style="width:140px">
              <label>상한(pt)</label>
              <input id="cap" type="text" readonly value="30" />
            </div>
            <div style="width:120px">
              <label>총 pt</label>
              <input id="totalPt" type="text" readonly value="0" />
            </div>
          </div>
        </div>

        <div class="panel" style="margin-bottom:12px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <strong style="color:var(--neon-blue)">카드 목록</strong>
            <div class="flex">
              <button id="addCard" class="btn">카드 추가</button>
              <button id="clearCards" class="btn ghost">초기화</button>
            </div>
          </div>

          <div class="card-list" id="cardList">
            <!-- 카드 항목들 -->
          </div>
        </div>

        <div class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <strong style="color:var(--neon-pink)">흐릿한 기억 게이지</strong>
            <div class="small muted">상한을 초과하면 저장 불가</div>
          </div>
          <div class="gauge-wrap">
            <div class="gauge">
              <div id="gaugeFill" class="gauge-fill"></div>
              <div id="gaugeText" class="gauge-text">0 / 30 pt</div>
            </div>
            <div style="display:flex;justify-content:space-between;margin-top:8px">
              <div class="small muted">금기카드는 항상 저장(20pt)</div>
              <div class="small muted">번뜩임/신 번뜩임은 추가 pt 적용</div>
            </div>
          </div>

          <div id="alertFull" class="alert" style="margin-top:10px">기억 게이지가 꽉 찼습니다! (저장 상한 도달)</div>
        </div>

      </div>

      <div>
        <div class="panel" style="margin-bottom:12px">
          <strong style="color:var(--neon-blue)">실행 로그</strong>
          <div class="small muted" style="margin-bottom:8px">각 카드의 pt 기여 내역과 누적 로그가 표시됩니다.</div>
          <div id="logs" class="logs"></div>
          <div style="display:flex;gap:8px;margin-top:10px;justify-content:flex-end">
            <button id="exportLog" class="btn ghost">로그 복사</button>
            <button id="downloadJson" class="btn">JSON 내려받기</button>
          </div>
        </div>

        <div class="panel">
          <strong style="color:var(--neon-purple)">요약</strong>
          <div style="margin-top:8px;display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <div>
              <div class="small muted">저장 상한</div>
              <div id="summaryCap" style="font-weight:700">30 pt</div>
            </div>
            <div>
              <div class="small muted">총 누적 pt</div>
              <div id="summaryTotal" style="font-weight:700">0 pt</div>
            </div>
            <div>
              <div class="small muted">금기카드 수</div>
              <div id="summaryTaboo" style="font-weight:700">0</div>
            </div>
            <div>
              <div class="small muted">카드 수</div>
              <div id="summaryCount" style="font-weight:700">0</div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <template id="cardTemplate">
    <div class="card-item">
      <div style="display:flex;flex-direction:column;gap:6px">
        <select class="card-type">
          <option value="neutral">중립 카드</option>
          <option value="monster">몬스터 카드</option>
          <option value="taboo">금기 카드</option>
        </select>
        <div class="small muted">기본값: 중립 20 / 몬스터 80 / 금기 20</div>
      </div>

      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;align-items:center">
        <div>
          <label class="small muted">상태</label>
          <select class="state">
            <option value="normal">일반</option>
            <option value="spark">번뜩임</option>
            <option value="newspark">신 번뜩임</option>
          </select>
        </div>
        <div>
          <label class="small muted">제거 횟수</label>
          <input class="num-input remove-count" type="number" min="0" value="0" />
        </div>
        <div>
          <label class="small muted">복제 횟수</label>
          <input class="num-input dup-count" type="number" min="0" value="0" />
        </div>

        <div>
          <label class="small muted">변환 횟수</label>
          <input class="num-input trans-count" type="number" min="0" value="0" />
        </div>
        <div>
          <label class="small muted">고유 카드</label>
          <div><input type="checkbox" class="is-unique"/> 고유</div>
        </div>
        <div>
          <label class="small muted">시작 카드 제거</label>
          <div><input type="checkbox" class="is-startremove"/> 시작카드</div>
        </div>
      </div>

      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
        <div class="small muted right">기여: <span class="contrib">0</span> pt</div>
        <div style="display:flex;gap:6px">
          <button class="btn ghost remove-btn">제거</button>
        </div>
      </div>
    </div>
  </template>

  <script>
    // 규칙 상수
    const BASE = { neutral:20, monster:80, taboo:20 };
    const REMAP = {1:0,2:10,3:30,4:50}; // 5 이상은 70
    const DUPMAP = {...REMAP};

    // DOM
    const tierEl = document.getElementById('tier');
    const capEl = document.getElementById('cap');
    const totalPtEl = document.getElementById('totalPt');
    const cardListEl = document.getElementById('cardList');
    const addCardBtn = document.getElementById('addCard');
    const clearCardsBtn = document.getElementById('clearCards');
    const cardTemplate = document.getElementById('cardTemplate');
    const gaugeFill = document.getElementById('gaugeFill');
    const gaugeText = document.getElementById('gaugeText');
    const alertFull = document.getElementById('alertFull');
    const logsEl = document.getElementById('logs');
    const summaryCap = document.getElementById('summaryCap');
    const summaryTotal = document.getElementById('summaryTotal');
    const summaryTaboo = document.getElementById('summaryTaboo');
    const summaryCount = document.getElementById('summaryCount');
    const exportLogBtn = document.getElementById('exportLog');
    const downloadJsonBtn = document.getElementById('downloadJson');

    let logs = [];

    function calcCap(tier){
      const t = Math.max(1, parseInt(tier)||1);
      return 30 + (t-1)*10;
    }

    function mapCountToPt(count){
      count = parseInt(count)||0;
      if(count<=1) return 0;
      if(count>=5) return 70;
      return REMAP[count] || 0;
    }

    function formatPt(n){ return `${n} pt`; }

    function addLog(text){
      const time = new Date().toLocaleTimeString();
      logs.unshift(`[${time}] ${text}`);
      renderLogs();
    }

    function renderLogs(){
      logsEl.innerHTML = logs.map(l => `<div>${escapeHtml(l)}</div>`).join('');
    }

    function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    function createCard(){
      const node = document.importNode(cardTemplate.content, true);
      const el = node.querySelector('.card-item');
      const removeBtn = el.querySelector('.remove-btn');

      // events
      const inputs = el.querySelectorAll('select,input');
      inputs.forEach(i => i.addEventListener('input', updateAll));

      removeBtn.addEventListener('click', ()=>{ el.remove(); updateAll(); addLog('카드가 목록에서 제거되었습니다.'); });

      cardListEl.prepend(el);
      updateAll();
    }

    addCardBtn.addEventListener('click', ()=>{ createCard(); addLog('카드 추가됨'); });
    clearCardsBtn.addEventListener('click', ()=>{ if(confirm('모든 카드를 초기화합니다. 진행할까요?')){ cardListEl.innerHTML=''; updateAll(); addLog('카드 목록 초기화'); }});

    tierEl.addEventListener('input', updateAll);

    function calcCardContribution(cardEl){
      const type = cardEl.querySelector('.card-type').value;
      const state = cardEl.querySelector('.state').value; // normal, spark, newspark
      const removeCount = parseInt(cardEl.querySelector('.remove-count').value)||0;
      const dupCount = parseInt(cardEl.querySelector('.dup-count').value)||0;
      const transCount = parseInt(cardEl.querySelector('.trans-count').value)||0;
      const isUnique = cardEl.querySelector('.is-unique').checked;
      const isStartRemove = cardEl.querySelector('.is-startremove').checked;

      let details = [];
      // base
      let base = BASE[type] || 0;
      details.push(`기본(${type}): ${base}pt`);

      // 번뜩임 보정
      let sparkAdd = 0;
      if(state === 'spark'){
        // 고유 카드의 번뜩임은 0
        sparkAdd = isUnique ? 0 : 10;
        if(sparkAdd>0) details.push(`번뜩임: +${sparkAdd}pt`);
        else details.push(`고유카드 번뜩임: +0pt`);
      } else if(state === 'newspark'){
        sparkAdd = 20; // 신 번뜩임은 +20 (고유이든 아니든 적용)
        details.push(`신 번뜩임: +${sparkAdd}pt`);
      }

      // 제거
      const removePt = mapCountToPt(removeCount);
      if(removeCount>0) details.push(`제거 횟수 ${removeCount}회 → ${removePt}pt`);

      // 제거 추가: 시작 카드 또는 번뜩임 카드 제거 시 +20
      let removeExtra = 0;
      if(removeCount>0 && (isStartRemove || state === 'spark' || state === 'newspark')){
        removeExtra = 20;
        details.push(`제거 추가(시작/번뜩임): +20pt`);
      }

      // 복제
      const dupPt = mapCountToPt(dupCount);
      if(dupCount>0) details.push(`복제 ${dupCount}회 → ${dupPt}pt`);

      // 복제된 카드가 번뜩임이면 복제본에도 추가 pt 적용
      let dupSparkAdd = 0;
      if(dupCount>0 && (state === 'spark' || state === 'newspark')){
        dupSparkAdd = (state === 'spark') ? (isUnique ? 0 : 10) : 20;
        details.push(`복제된 카드의 번뜩임 보정: +${dupSparkAdd}pt (복제본당)`);
      }

      // 변환
      const transPt = (transCount||0) * 10;
      if(transCount>0) details.push(`변환 ${transCount}회 → ${transPt}pt`);
      // 변환된 카드가 번뜩임이면 그 보정도 추가
      let transSparkAdd = 0;
      if(transCount>0 && (state === 'spark' || state === 'newspark')){
        transSparkAdd = (state === 'spark') ? (isUnique ? 0 : 10) : 20;
        details.push(`변환된 카드의 번뜩임 보정: +${transSparkAdd}pt (변환당)`);
      }

      // 합산 로직
      // 기본 카드는 기본값만 1장이라고 가정
      let total = 0;

      // 금기 카드는 항상 저장(20pt)
      if(type === 'taboo'){
        total += base; // 20
        details.push('금기카드: 항상 저장(20pt)');
      } else {
        // 기본 카드 기여
        total += base;

        // 번뜩임 추가(본체)
        total += sparkAdd;

        // 제거 기록(pt)
        total += removePt + removeExtra;

        // 복제: 복제 '횟수'에 따른 기록. 복제 1회차는 0pt (원본 제외), 2회차 이상은 추가 pt
        // For simplicity, duplication pts are considered as the mapped pt (dupPt) plus per-dup additional spark for each duplicated copy beyond first
        total += dupPt;
        if(dupCount>1) {
          // 복제된 카드의 번뜩임 보정은 복제본(=복제 횟수) 당 추가
          total += dupSparkAdd * (dupCount);
        } else if(dupCount===1 && dupSparkAdd>0){
          // dupCount==1 maps to 0 dupPt but still create one duplicated card that inherits spark; spec says 1회차 0pt
          // We'll treat duplicated card's spark add as applied once only if dupCount>=1 and dupSparkAdd>0
          total += dupSparkAdd;
        }

        // 변환
        total += transPt;
        if(transCount>0) total += transSparkAdd * transCount;
      }

      // contribution displayed
      const contribEl = cardEl.querySelector('.contrib');
      contribEl.textContent = total;

      // Build detail text
      const summary = `카드(${type}, 상태:${state}${isUnique?', 고유':''}) 기여 = ${total}pt | ${details.join(' / ')}`;
      return { total, summary, type };
    }

    function updateAll(){
      const tier = parseInt(tierEl.value) || 1;
      const cap = calcCap(tier);
      capEl.value = cap;
      summaryCap.textContent = `${cap} pt`;

      // calc for each card
      let total = 0;
      let tabooCount = 0;
      let cardCount = 0;
      const children = Array.from(cardListEl.querySelectorAll('.card-item'));
      const contributions = [];
      children.forEach(node =>{
        const c = calcCardContribution(node);
        contributions.push(c);
        total += c.total;
        if(c.type === 'taboo') tabooCount++;
        cardCount++;
      });

      // update UI
      totalPtEl.value = `${total}`;
      summaryTotal.textContent = `${total} pt`;
      summaryTaboo.textContent = `${tabooCount}`;
      summaryCount.textContent = `${cardCount}`;

      // gauge
      const pct = Math.min(100, Math.round((total / cap) * 100));
      gaugeFill.style.width = pct + '%';
      gaugeText.textContent = `${total} / ${cap} pt`;

      // logs: rebuild
      // We'll add per card details as the top log
      // keep logs (user-requested) - separate from dynamic per-card summary
      // Add temporary summary of calculation
      const now = new Date();
      const summaryLog = `계산: Tier ${tier} (Cap ${cap}pt) → 총 ${total}pt, 카드 ${cardCount}개, 금기 ${tabooCount}개`;
      // push a short entry at top (but don't spam: only add if last log is different or if no logs)
      if(!logs.length || logs[0].includes('계산:')===false){
        logs.unshift(`[${now.toLocaleTimeString()}] ${summaryLog}`);
      } else {
        logs[0] = `[${now.toLocaleTimeString()}] ${summaryLog}`;
      }
      // Also append each card's summary
      contributions.forEach(c => logs.splice(1,0,`[${now.toLocaleTimeString()}] ${c.summary}`));
      // limit logs length to 200
      if(logs.length>200) logs = logs.slice(0,200);
      renderLogs();

      // alert when full or over
      if(total >= cap){
        alertFull.style.display = 'block';
        // pulse effect
        alertFull.animate([{opacity:0.9},{opacity:1},{opacity:0.9}],{duration:900,iterations:Infinity});
        // make gauge red-ish
        gaugeFill.style.boxShadow = '0 0 24px rgba(255,60,90,0.6)';
      } else {
        alertFull.style.display = 'none';
        gaugeFill.style.boxShadow = '';
      }
    }

    // utilities
    exportLogBtn.addEventListener('click', ()=>{
      navigator.clipboard.writeText(logs.join('\n')).then(()=>{ alert('로그가 클립보드에 복사되었습니다.'); }).catch(()=>{ alert('복사 실패'); });
    });

    downloadJsonBtn.addEventListener('click', ()=>{
      const data = {
        tier: parseInt(tierEl.value)||1,
        cap: capEl.value,
        totalPt: totalPtEl.value,
        cards: Array.from(cardListEl.querySelectorAll('.card-item')).map(el=>{
          return {
            type: el.querySelector('.card-type').value,
            state: el.querySelector('.state').value,
            removeCount: parseInt(el.querySelector('.remove-count').value)||0,
            dupCount: parseInt(el.querySelector('.dup-count').value)||0,
            transCount: parseInt(el.querySelector('.trans-count').value)||0,
            isUnique: el.querySelector('.is-unique').checked,
            isStartRemove: el.querySelector('.is-startremove').checked,
            contrib: parseInt(el.querySelector('.contrib').textContent)||0
          }
        })
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'chaos_save_simulator_export.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    // initial state
    createCard();
    createCard();
    updateAll();

  </script>
</body>
</html>
