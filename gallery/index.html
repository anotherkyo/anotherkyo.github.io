<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>갤러리 데모 · 관리/확장 기능 포함</title>
  <style>
    :root {
      --bg: #0b0c0f;
      --card: #11131a;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #60a5fa;
      --ring: #93c5fd66;
    }
    @media (prefers-color-scheme: light) {
      :root { --bg:#f8fafc; --card:#ffffff; --text:#111827; --muted:#6b7280; --accent:#2563eb; --ring:#2563eb33; }
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Noto Sans KR, Apple SD Gothic Neo, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background: var(--bg); color: var(--text); }

    header { position: sticky; top: 0; z-index: 20; backdrop-filter: saturate(180%) blur(8px); background: color-mix(in oklab, var(--bg) 80%, transparent); border-bottom: 1px solid color-mix(in oklab, var(--text) 10%, transparent); }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 20px; }
    h1 { margin: 0; font-size: clamp(20px, 2.8vw, 36px); letter-spacing: -0.02em; }
    .sub { color: var(--muted); margin-top: 6px; font-size: 14px; }
    .toolbar { display: flex; gap: 10px; align-items: center; margin-top: 14px; flex-wrap: wrap; }
    .btn { border: 1px solid color-mix(in oklab, var(--text) 12%, transparent); background: var(--card); color: var(--text); padding: 8px 12px; border-radius: 999px; cursor: pointer; transition: transform .12s ease, box-shadow .2s ease; box-shadow: 0 1px 0 rgba(0,0,0,.05), 0 6px 12px rgba(2,6,23,.12) inset; }
    .btn:hover { transform: translateY(-1px); }
    .btn[aria-pressed="true"] { outline: 2px solid var(--ring); outline-offset: 2px; color: var(--accent); border-color: var(--accent); }
    .search { flex: 1 1 220px; position: relative; }
    .search input { width: 100%; padding: 10px 12px 10px 36px; border-radius: 12px; border: 1px solid color-mix(in oklab, var(--text) 12%, transparent); background: var(--card); color: var(--text); }
    .search svg { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); opacity: .6; }

    .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 12px; margin-top: 18px; }
    .card { position: relative; overflow: clip; border-radius: 16px; background: var(--card); border: 1px solid color-mix(in oklab, var(--text) 10%, transparent); }
    .card img { width: 100%; height: 100%; aspect-ratio: 4/3; object-fit: cover; display: block; transition: transform .35s ease; }
    .card .badge { position: absolute; top: 8px; left: 8px; padding: 4px 8px; font-size: 12px; background: color-mix(in oklab, var(--bg) 60%, transparent); border: 1px solid color-mix(in oklab, var(--text) 12%, transparent); border-radius: 999px; }
    .card button { all: unset; cursor: zoom-in; position: absolute; inset: 0; }
    .card:hover img { transform: scale(1.04); }

    dialog#lightbox { width: 100vw; max-width: none; height: 100vh; border: none; padding: 0; background: color-mix(in oklab, #000 75%, transparent); }
    dialog::backdrop { background: rgba(0,0,0,.6); }
    .viewer { position: relative; width: 100%; height: 100%; display: grid; place-items: center; }
    .viewer img { max-width: min(92vw, 1400px); max-height: 80vh; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,.4); }
    .viewer figcaption { margin-top: 12px; color: var(--muted); text-align: center; }
    .nav { position: absolute; inset: 0; display: flex; align-items: center; justify-content: space-between; pointer-events: none; }
    .nav button { pointer-events: auto; border: 1px solid color-mix(in oklab, var(--text) 10%, transparent); background: color-mix(in oklab, var(--bg) 60%, transparent); color: var(--text); width: 44px; height: 44px; border-radius: 999px; display: grid; place-items: center; cursor: pointer; margin: 0 16px; }
    .close { position: absolute; top: 16px; right: 16px; }

    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
    footer { text-align: center; color: var(--muted); padding: 30px 0 50px; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>갤러리</h1>
      <p class="sub">이미지 배열 관리 스크립트 + 무한 스크롤 + 드래그 업로드 + URL 딥링크 + 모바일 제스처</p>
      <div class="toolbar" role="toolbar">
        <div class="search" role="search">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-3.5-3.5"></path></svg>
          <input id="q" type="search" placeholder="검색(제목/태그)" autocomplete="off" />
        </div>
        <div class="filters">
          <button class="btn" data-tag="all" aria-pressed="true">전체</button>
          <button class="btn" data-tag="people">인물</button>
          <button class="btn" data-tag="city">도시</button>
          <button class="btn" data-tag="nature">자연</button>
          <button class="btn" data-tag="food">음식</button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="gallery" id="gallery"></section>
  </main>

  <dialog id="lightbox">
    <div class="viewer">
      <button class="btn close" data-action="close">✕</button>
      <div class="nav">
        <button class="btn" data-action="prev">‹</button>
        <button class="btn" data-action="next">›</button>
      </div>
      <figure>
        <img id="lb-img" alt="" />
        <figcaption id="lb-cap"> </figcaption>
      </figure>
    </div>
  </dialog>

  <footer>
    <small>© 2025 Gallery Demo</small>
  </footer>

  <script>
    function convertGoogleDriveLink(url) {
      // file ID만 추출
      const match = url.match(/[-\w]{25,}/);
      return match ? `https://drive.google.com/uc?export=view&id=${match[0]}` : url;
    }

    
    // ===== 이미지 데이터 배열 =====
    const images = [
      {src:"https://redpanda7301.github.io/langrisser/img/card/%EA%B0%81%EC%84%B1%EC%9E%90%EC%B4%88%EC%A0%88.webp", 
      full:"https://drive.google.com/file/d/1NeIiMxrdzzBBgDcFEon2TLNpcjTckUao/view?usp=drive_link", 
      title:"각성자", tags:["people","city"]},
      {src:"https://picsum.photos/id/103/600/450", full:"https://picsum.photos/id/103/1600/1200", title:"초록 숲길", tags:["nature"]},
      {src:"https://picsum.photos/id/1011/600/450", full:"https://picsum.photos/id/1011/1600/1200", title:"야경 스카이라인", tags:["city"]},
      {src:"https://picsum.photos/id/1080/600/450", full:"https://picsum.photos/id/1080/1600/1200", title:"디저트", tags:["food"]},
      {src:"https://picsum.photos/id/1018/600/450", full:"https://picsum.photos/id/1018/1600/1200", title:"해변", tags:["nature"]},
      {src:"https://picsum.photos/id/1005/600/450", full:"https://picsum.photos/id/1005/1600/1200", title:"초상", tags:["people"]},
      {src:"https://picsum.photos/id/1056/600/450", full:"https://picsum.photos/id/1056/1600/1200", title:"골목", tags:["city"]},
      {src:"https://picsum.photos/id/1081/600/450", full:"https://picsum.photos/id/1081/1600/1200", title:"브런치", tags:["food"]},
      {src:"https://picsum.photos/id/1002/600/450", full:"https://picsum.photos/id/1002/1600/1200", title:"산맥", tags:["nature"]},
    ];

    const gallery = document.getElementById('gallery');
    let loadedCount = 0;
    const pageSize = 4;

    function renderMore() {
      const end = Math.min(loadedCount + pageSize, images.length);
      for (let i = loadedCount; i < end; i++) {
        const img = images[i];
        // src와 full을 변환 함수로 보정
        const srcUrl = convertGoogleDriveLink(img.src);
        const fullUrl = convertGoogleDriveLink(img.full);

        const fig = document.createElement('figure');
        fig.className = 'card';
        fig.dataset.tags = img.tags.join(',');
        fig.dataset.title = img.title;
        fig.innerHTML = `
          <img src="${srcUrl}" loading="lazy" decoding="async" 
              alt="${img.title}" data-full="${fullUrl}"/>
          <span class="badge">${img.tags[0]}</span>
          <figcaption class="sr-only">${img.title}</figcaption>
          <button></button>`;
        gallery.appendChild(fig);
      }
      loadedCount = end;
    }
    renderMore();

    // 무한 스크롤
    window.addEventListener('scroll',()=>{
      if(window.innerHeight+window.scrollY>=document.body.offsetHeight-200){
        renderMore();
      }
    });

    // 검색 & 필터
    const q=document.getElementById('q');
    const filterButtons=document.querySelectorAll('.filters .btn');
    let activeTag='all';
    function applyFilter(){
      const term=(q.value||'').toLowerCase();
      [...gallery.children].forEach(card=>{
        const tags=(card.dataset.tags||'').toLowerCase();
        const title=(card.dataset.title||'').toLowerCase();
        const byTag=activeTag==='all'||tags.includes(activeTag);
        const bySearch=!term||tags.includes(term)||title.includes(term);
        card.style.display=byTag&&bySearch?'':'none';
      });
    }
    q.addEventListener('input',applyFilter);
    filterButtons.forEach(btn=>btn.addEventListener('click',()=>{activeTag=btn.dataset.tag;filterButtons.forEach(b=>b.setAttribute('aria-pressed',String(b===btn)));applyFilter();}));

    // 라이트박스 + URL 파라미터 딥링크
    const dialog=document.getElementById('lightbox');
    const lbImg=document.getElementById('lb-img');
    const lbCap=document.getElementById('lb-cap');
    let items=[]; let index=0;

    function refreshItems(){items=[...gallery.querySelectorAll('.card')];}
    function openAt(i){
      refreshItems(); index=i;
      const fig=items[index]; const img=fig.querySelector('img');
      lbImg.src=img.dataset.full||img.src; lbCap.textContent=fig.dataset.title||'';
      dialog.showModal();
      const url=new URL(location); url.searchParams.set('img',index); history.replaceState({},'',url);
    }
    function close(){dialog.close(); const url=new URL(location); url.searchParams.delete('img'); history.replaceState({},'',url);}
    function prev(){openAt((index-1+items.length)%items.length);} function next(){openAt((index+1)%items.length);}

    gallery.addEventListener('click',e=>{const fig=e.target.closest('figure');if(fig)openAt([...gallery.children].indexOf(fig));});
    document.querySelector('[data-action="close"]').onclick=close;
    document.querySelector('[data-action="prev"]').onclick=prev;
    document.querySelector('[data-action="next"]').onclick=next;
    document.addEventListener('keydown',e=>{if(!dialog.open)return;if(e.key==='Escape')close();if(e.key==='ArrowLeft')prev();if(e.key==='ArrowRight')next();});
    dialog.addEventListener('click',e=>{if(!e.target.closest('.viewer'))close();});

    // 드래그&드롭 업로드
    gallery.addEventListener('dragover',e=>{e.preventDefault();});
    gallery.addEventListener('drop',e=>{
      e.preventDefault();
      const files=[...e.dataTransfer.files].filter(f=>f.type.startsWith('image/'));
      files.forEach(f=>{
        const url=URL.createObjectURL(f);
        images.push({src:url,full:url,title:f.name,tags:["uploaded"]});
        renderMore();
      });
    });

    // 모바일 제스처 스와이프
    let startX=0;
    dialog.addEventListener('touchstart',e=>{startX=e.touches[0].clientX;});
    dialog.addEventListener('touchend',e=>{let dx=e.changedTouches[0].clientX-startX;if(Math.abs(dx)>60){if(dx>0)prev();else next();}});

    // URL 딥링크로 바로 열기
    window.addEventListener('load',()=>{const p=new URL(location).searchParams.get('img');if(p!==null){setTimeout(()=>openAt(Number(p)),500);}});
  </script>
</body>
</html>
